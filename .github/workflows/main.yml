name: Build NDK

on:
  workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    steps:
    - name: Checkout project
      uses: actions/checkout@v4

    - name: Install all build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl python3 python3-pip python3-venv
        sudo apt-get install -y build-essential cmake ninja-build clang lld
        sudo apt-get install -y bison flex libssl-dev zlib1g-dev libxml2-dev
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        sudo apt-get install -y yasm nasm zip

    - name: Install repo tool
      run: |
        sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod a+x /usr/local/bin/repo

    - name: Get Android source
      run: |
        mkdir -p android-source
        cd android-source
        repo init -u https://android.googlesource.com/platform/manifest -b llvm-toolchain --depth=1
        repo sync -c -j2 --no-tags

    - name: Apply custom config
      run: |
        cd android-source/toolchain
        rm -rf llvm_android
        cp -r ${{ github.workspace }} llvm_android

    - name: Build
      run: |
        cd android-source
        python3 toolchain/llvm_android/build.py \
          --no-build windows \
          --skip-tests \
          --single-stage \
          --no-musl

    - name: Package output
      run: |
        cd android-source
        mkdir -p ndk-output/toolchains/llvm/prebuilt/linux-aarch64
        cp -r out/stage2/* ndk-output/toolchains/llvm/prebuilt/linux-aarch64/
        cd ndk-output
        tar czf ../ndk-aarch64.tar.gz .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ndk-aarch64
        path: android-source/ndk-aarch64.tar.gz
