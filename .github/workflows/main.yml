name: ðŸ”§ Build Android NDK for AArch64 Linux Host

on:
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Target host triple (é€šå¸¸ä¸º aarch64-linux-gnu)'
        required: true
        default: 'aarch64-linux-gnu'
      skip_stage1:
        description: 'è·³è¿‡ stage1 æž„å»ºï¼ˆå¦‚å·²æœ‰ bootstrap compilerï¼‰'
        required: false
        default: 'false'

# ä¸ºæ•´ä¸ªå·¥ä½œæµè®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼ˆæŽ¥è¿‘GitHubå…è´¹å¥—é¤6å°æ—¶é™åˆ¶ï¼‰
env:
  # ========== æ ¸å¿ƒè·¯å¾„é…ç½® ==========
  WORKSPACE: ${{ github.workspace }}
  LLVM_SOURCE_ROOT: ${{ github.workspace }}/llvm_android_source
  CUSTOM_CONFIG_DIR: ${{ github.workspace }}/custom_llvm_android_config
  BUILD_OUTPUT_DIR: ${{ github.workspace }}/build_output
  ARTIFACT_STAGING: ${{ github.workspace }}/artifacts
  
  # ========== æž„å»ºå‚æ•°é…ç½® ==========
  TARGET_HOST: ${{ github.event.inputs.build_target || 'aarch64-linux-gnu' }}
  BUILD_TYPE: 'Release'
  PARALLEL_JOBS: 4  # æŽ§åˆ¶å¹¶è¡Œåº¦ä»¥é¿å…OOM
  
  # ========== ç³»ç»Ÿå·¥å…·ç‰ˆæœ¬é…ç½® ==========
  CMAKE_VERSION: '3.29.0'
  NINJA_VERSION: '1.11.1'
  PYTHON_VERSION: '3.10'
  
  # ========== é•œåƒæºé…ç½®ï¼ˆåŠ é€Ÿä¸‹è½½ï¼‰ ==========
  PIP_INDEX_URL: 'https://pypi.tuna.tsinghua.edu.cn/simple'
  UBUNTU_MIRROR: 'http://mirrors.aliyun.com/ubuntu/'

jobs:
  # ========== é˜¶æ®µä¸€ï¼šå‡†å¤‡å®Œæ•´æž„å»ºçŽ¯å¢ƒ ==========
  prepare-environment:
    name: "ðŸ—ï¸ å‡†å¤‡å®Œæ•´æž„å»ºçŽ¯å¢ƒ"
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
    - name: "ðŸ“¦ æ£€å‡ºè‡ªå®šä¹‰é…ç½®ä»“åº“"
      uses: actions/checkout@v4
      with:
        path: ${{ env.CUSTOM_CONFIG_DIR }}
        fetch-depth: 0
    
    - name: "ðŸ“ çŽ¯å¢ƒä¿¡æ¯è¯Šæ–­"
      run: |
        echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
        uname -a
        echo "=== å†…å­˜ä¿¡æ¯ ==="
        free -h
        echo "=== ç£ç›˜ä¿¡æ¯ ==="
        df -h
        echo "=== CPUä¿¡æ¯ ==="
        lscpu | grep -E "^(CPU\(s\)|Thread|Core|Socket|Model name)"
        echo "=== GitHub Runner ä¿¡æ¯ ==="
        echo "Runner OS: $RUNNER_OS"
        echo "Runner Arch: $RUNNER_ARCH"
        echo "=== çŽ¯å¢ƒå˜é‡ ==="
        echo "WORKSPACE: $WORKSPACE"
        echo "TARGET_HOST: $TARGET_HOST"
    
    - name: "ðŸ”§ é…ç½®Ubuntuè½¯ä»¶æºï¼ˆé˜¿é‡Œäº‘é•œåƒï¼‰"
      run: |
        sudo sed -i "s|http://archive.ubuntu.com|${{ env.UBUNTU_MIRROR }}|g" /etc/apt/sources.list
        sudo sed -i "s|http://security.ubuntu.com|${{ env.UBUNTU_MIRROR }}|g" /etc/apt/sources.list
        sudo apt-get update --fix-missing
    
    - name: "ðŸ“¥ å®‰è£…ç³»ç»ŸåŸºç¡€å·¥å…·å’Œåº“ï¼ˆç¬¬1éƒ¨åˆ†ï¼šåŸºç¡€ç¼–è¯‘çŽ¯å¢ƒï¼‰"
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          software-properties-common apt-transport-https ca-certificates gnupg \
          wget curl git subversion mercurial \
          build-essential autoconf automake libtool pkg-config \
          gettext texinfo flex bison gperf \
          lsb-release sudo rsync jq
    
    - name: "ðŸ“¥ å®‰è£…ç³»ç»ŸåŸºç¡€å·¥å…·å’Œåº“ï¼ˆç¬¬2éƒ¨åˆ†ï¼šæ–‡ä»¶ä¸ŽåŽ‹ç¼©å·¥å…·ï¼‰"
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          zip unzip zstd lz4 xz-utils liblzma-dev \
          libarchive-dev libarchive-tools \
          file tree ncdu pv
    
    - name: "ðŸ“¥ å®‰è£…ç³»ç»ŸåŸºç¡€å·¥å…·å’Œåº“ï¼ˆç¬¬3éƒ¨åˆ†ï¼šå¼€å‘åº“ï¼‰"
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          zlib1g-dev libbz2-dev liblzma-dev \
          libssl-dev libssl3 openssl \
          libxml2-dev libxml2-utils \
          libncurses5-dev libncursesw5-dev \
          libedit-dev libreadline-dev \
          libffi-dev libgdbm-dev libsqlite3-dev \
          libexpat1-dev libudev-dev \
          libpcre2-dev libpcre3-dev \
          libglib2.0-dev libpixman-1-dev \
          libc6-dev libc6-dev-i386 lib32gcc-dev \
          lib32stdc++6 gcc-multilib g++-multilib
    
    - name: "ðŸ“¥ å®‰è£…ç³»ç»ŸåŸºç¡€å·¥å…·å’Œåº“ï¼ˆç¬¬4éƒ¨åˆ†ï¼šè¯­è¨€è¿è¡Œæ—¶ï¼‰"
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          python3 python3-dev python3-pip python3-venv python3-full \
          python2 python2-dev \
          perl ruby ruby-dev \
          tcl tcl-dev tk tk-dev
    
    - name: "ðŸ é…ç½®PythonçŽ¯å¢ƒå’Œpipé•œåƒ"
      run: |
        python3 -m pip install --upgrade pip setuptools wheel
        python3 -m pip config set global.index-url ${{ env.PIP_INDEX_URL }}
        # å®‰è£…æž„å»ºå¯èƒ½éœ€è¦çš„PythonåŒ…
        python3 -m pip install \
          psutil \
          colorama \
          requests \
          pyyaml \
          jinja2
    
    - name: "ðŸ› ï¸ å®‰è£…é«˜çº§æž„å»ºå·¥å…·ï¼ˆCMakeä»Žæºç ç¼–è¯‘ï¼‰"
      run: |
        cd /tmp
        wget https://github.com/Kitware/CMake/releases/download/v${{ env.CMAKE_VERSION }}/cmake-${{ env.CMAKE_VERSION }}-linux-x86_64.tar.gz
        tar -xzf cmake-${{ env.CMAKE_VERSION }}-linux-x86_64.tar.gz
        sudo cp -r cmake-${{ env.CMAKE_VERSION }}-linux-x86_64/* /usr/local/
        cmake --version
    
    - name: "ðŸ› ï¸ å®‰è£…Ninjaæž„å»ºç³»ç»Ÿ"
      run: |
        cd /tmp
        wget https://github.com/ninja-build/ninja/releases/download/v${{ env.NINJA_VERSION }}/ninja-linux.zip
        unzip ninja-linux.zip
        sudo install ninja /usr/local/bin/
        ninja --version
    
    - name: "ðŸŽ¯ å®‰è£…ç›®æ ‡æž¶æž„äº¤å‰ç¼–è¯‘å·¥å…·é“¾"
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          crossbuild-essential-arm64 \
          gcc-${{ env.TARGET_HOST }} g++-${{ env.TARGET_HOST }} \
          gcc-${{ env.TARGET_HOST }}-multilib g++-${{ env.TARGET_HOST }}-multilib \
          binutils-${{ env.TARGET_HOST }} \
          libc6-dev-${{ env.TARGET_HOST }}-cross \
          libgcc-${{ env.TARGET_HOST }}-dev \
          libstdc++-${{ env.TARGET_HOST }}-dev
        
        # éªŒè¯äº¤å‰ç¼–è¯‘å™¨
        ${{ env.TARGET_HOST }}-gcc --version
        ${{ env.TARGET_HOST }}-g++ --version
    
    - name: "ðŸ”¨ å®‰è£…æ±‡ç¼–å™¨å’Œä½Žçº§å·¥å…·"
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          yasm nasm \
          xorriso mtools \
          qemu-user-static binfmt-support \
          llvm-dev libllvm-dev clang lld \
          golang-go \
          rustc cargo \
          nodejs npm
    
    - name: "ðŸ“ å®‰è£…Android repoå·¥å…·"
      run: |
        sudo curl -s https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod a+x /usr/local/bin/repo
        echo "âœ… repoå·¥å…·å·²å®‰è£…:"
        repo --version
    
    - name: "ðŸ“Š åˆ›å»ºçŽ¯å¢ƒçŠ¶æ€æŠ¥å‘Š"
      run: |
        echo "=== çŽ¯å¢ƒå‡†å¤‡å®ŒæˆæŠ¥å‘Š ===" > ${{ env.WORKSPACE }}/environment_report.txt
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> ${{ env.WORKSPACE }}/environment_report.txt
        echo "" >> ${{ env.WORKSPACE }}/environment_report.txt
        
        echo "--- å…³é”®å·¥å…·ç‰ˆæœ¬ ---" >> ${{ env.WORKSPACE }}/environment_report.txt
        gcc --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        g++ --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        ${{ env.TARGET_HOST }}-gcc --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        cmake --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        ninja --version >> ${{ env.WORKSPACE }}/environment_report.txt
        python3 --version >> ${{ env.WORKSPACE }}/environment_report.txt
        repo --version >> ${{ env.WORKSPACE }}/environment_report.txt
        clang --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        lld --version | head -1 >> ${{ env.WORKSPACE }}/environment_report.txt
        
        echo "" >> ${{ env.WORKSPACE }}/environment_report.txt
        echo "--- ç£ç›˜ä½¿ç”¨æƒ…å†µ ---" >> ${{ env.WORKSPACE }}/environment_report.txt
        df -h ${{ env.WORKSPACE }} >> ${{ env.WORKSPACE }}/environment_report.txt
        
        echo "âœ… çŽ¯å¢ƒæŠ¥å‘Šå·²ä¿å­˜"
        cat ${{ env.WORKSPACE }}/environment_report.txt
    
    outputs:
      environment-ready: 'true'
      target-host: ${{ env.TARGET_HOST }}

  # ========== é˜¶æ®µäºŒï¼šèŽ·å–å’Œå‡†å¤‡æºä»£ç  ==========
  fetch-and-prepare-source:
    name: "ðŸ“¥ èŽ·å–å’Œå‡†å¤‡æºä»£ç "
    runs-on: ubuntu-22.04
    needs: prepare-environment
    timeout-minutes: 90
    
    steps:
    - name: "ðŸ“¦ æ£€å‡ºè‡ªå®šä¹‰é…ç½®"
      uses: actions/checkout@v4
      with:
        path: ${{ env.CUSTOM_CONFIG_DIR }}
    
    - name: "ðŸ“ æ¢å¤å·¥ä½œåŒº"
      uses: actions/download-artifact@v4
      with:
        name: environment-report
        path: ${{ env.WORKSPACE }}
    
    - name: "ðŸŒ åˆå§‹åŒ–Android LLVMä»£ç ä»“åº“"
      run: |
        mkdir -p ${{ env.LLVM_SOURCE_ROOT }}
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        echo "æ­¥éª¤1: åˆå§‹åŒ–repoä»“åº“..."
        repo init -u https://android.googlesource.com/platform/manifest \
          -b llvm-toolchain \
          --depth=1 \
          --repo-rev=main \
          --no-clone-bundle
        
        echo "æ­¥éª¤2: é…ç½®gitå‚æ•°ä»¥ä¼˜åŒ–å¤§ä»“åº“å…‹éš†..."
        git config --global user.email "builder@github.actions"
        git config --global user.name "GitHub Actions Builder"
        git config --global core.compression 0
        git config --global core.loosecompression 0
        git config --global pack.depth 1
        git config --global pack.window 0
        
        echo "æ­¥éª¤3: åŒæ­¥ä»£ç ä»“åº“ï¼ˆè¿™ä¸€æ­¥è€—æ—¶è¾ƒé•¿ï¼‰..."
        repo sync -c -j${{ env.PARALLEL_JOBS }} \
          --no-tags \
          --no-clone-bundle \
          --optimized-fetch \
          --prune
        
        echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
        du -sh ${{ env.LLVM_SOURCE_ROOT }}
    
    - name: "ðŸ”§ åº”ç”¨è‡ªå®šä¹‰æž„å»ºé…ç½®"
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        echo "å¤‡ä»½åŽŸå§‹toolchain/llvm_androidç›®å½•..."
        if [ -d toolchain/llvm_android ]; then
          mv toolchain/llvm_android toolchain/llvm_android.google.backup
          echo "åŽŸå§‹é…ç½®å·²å¤‡ä»½åˆ°: toolchain/llvm_android.google.backup"
        fi
        
        echo "åº”ç”¨æ‚¨çš„è‡ªå®šä¹‰é…ç½®..."
        cp -r ${{ env.CUSTOM_CONFIG_DIR }} toolchain/llvm_android
        
        echo "éªŒè¯é…ç½®æ›¿æ¢ç»“æžœ..."
        echo "è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ•°é‡:"
        find toolchain/llvm_android -name "*.py" -type f | wc -l
        echo "å…³é”®æž„å»ºè„šæœ¬:"
        ls -la toolchain/llvm_android/build.py
        ls -la toolchain/llvm_android/configs.py
        ls -la toolchain/llvm_android/hosts.py
        
        echo "æ£€æŸ¥ç›®æ ‡ä¸»æœºé…ç½®..."
        grep -r "${{ env.TARGET_HOST }}" toolchain/llvm_android/configs.py toolchain/llvm_android/hosts.py || true
    
    - name: "ðŸ“‹ ç”Ÿæˆæºä»£ç çŠ¶æ€æŠ¥å‘Š"
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        echo "=== æºä»£ç çŠ¶æ€æŠ¥å‘Š ===" > ${{ env.WORKSPACE }}/source_report.txt
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> ${{ env.WORKSPACE }}/source_report.txt
        echo "æºç ç›®å½•: ${{ env.LLVM_SOURCE_ROOT }}" >> ${{ env.WORKSPACE }}/source_report.txt
        echo "" >> ${{ env.WORKSPACE }}/source_report.txt
        
        echo "--- ç›®å½•å¤§å° ---" >> ${{ env.WORKSPACE }}/source_report.txt
        du -sh . >> ${{ env.WORKSPACE }}/source_report.txt
        echo "" >> ${{ env.WORKSPACE }}/source_report.txt
        
        echo "--- å…³é”®ç›®å½•ç»“æž„ ---" >> ${{ env.WORKSPACE }}/source_report.txt
        find . -maxdepth 3 -type d | sort | head -50 >> ${{ env.WORKSPACE }}/source_report.txt
        
        echo "âœ… æºä»£ç æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat ${{ env.WORKSPACE }}/source_report.txt | tail -30

  # ========== é˜¶æ®µä¸‰ï¼šæ‰§è¡Œå®Œæ•´æž„å»º ==========
  execute-build:
    name: "ðŸš€ æ‰§è¡Œå®Œæ•´æž„å»º"
    runs-on: ubuntu-22.04
    needs: fetch-and-prepare-source
    timeout-minutes: 280
    
    steps:
    - name: "ðŸ“ æ¢å¤å·¥ä½œåŒº"
      uses: actions/download-artifact@v4
      with:
        name: source-artifacts
        path: ${{ env.WORKSPACE }}
    
    - name: "âš™ï¸ é…ç½®æž„å»ºçŽ¯å¢ƒå˜é‡"
      run: |
        echo "=== æž„å»ºçŽ¯å¢ƒå˜é‡é…ç½® ==="
        echo "TARGET_HOST: ${{ env.TARGET_HOST }}"
        echo "BUILD_TYPE: ${{ env.BUILD_TYPE }}"
        echo "PARALLEL_JOBS: ${{ env.PARALLEL_JOBS }}"
        echo "WORKSPACE: ${{ env.WORKSPACE }}"
        
        # è®¾ç½®æž„å»ºç‰¹å®šçŽ¯å¢ƒå˜é‡
        export CC=clang
        export CXX=clang++
        export AR=llvm-ar
        export RANLIB=llvm-ranlib
        export LD=lld
        
        # ä¸ºæž„å»ºè¿‡ç¨‹è®¾ç½®å¿…è¦çš„é“¾æŽ¥å™¨æ ‡å¿—
        export LDFLAGS="-fuse-ld=lld -Wl,--gc-sections"
        export CFLAGS="-O2 -pipe"
        export CXXFLAGS="-O2 -pipe -stdlib=libc++"
        
        # ä¿å­˜åˆ°çŽ¯å¢ƒæ–‡ä»¶ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "CC=$CC" >> $GITHUB_ENV
        echo "CXX=$CXX" >> $GITHUB_ENV
        echo "AR=$AR" >> $GITHUB_ENV
        echo "RANLIB=$RANLIB" >> $GITHUB_ENV
        echo "LD=$LD" >> $GITHUB_ENV
        echo "LDFLAGS=$LDFLAGS" >> $GITHUB_ENV
        echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
        echo "CXXFLAGS=$CXXFLAGS" >> $GITHUB_ENV
    
    - name: "ðŸ” é¢„æž„å»ºæ£€æŸ¥"
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        echo "=== é¢„æž„å»ºç³»ç»Ÿæ£€æŸ¥ ==="
        
        echo "1. æ£€æŸ¥å…³é”®å·¥å…·..."
        command -v cmake && cmake --version | head -1
        command -v ninja && ninja --version
        command -v python3 && python3 --version
        command -v clang && clang --version | head -1
        command -v ${{ env.TARGET_HOST }}-gcc && ${{ env.TARGET_HOST }}-gcc --version | head -1
        
        echo ""
        echo "2. æ£€æŸ¥ç£ç›˜ç©ºé—´..."
        df -h ${{ env.WORKSPACE }}
        
        echo ""
        echo "3. æ£€æŸ¥å†…å­˜..."
        free -h
        
        echo ""
        echo "4. éªŒè¯æºä»£ç ç›®å½•..."
        if [ -d toolchain/llvm_android ]; then
          echo "âœ… è‡ªå®šä¹‰é…ç½®ç›®å½•å­˜åœ¨"
          ls toolchain/llvm_android/*.py | wc -l
        else
          echo "âŒ è‡ªå®šä¹‰é…ç½®ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo ""
        echo "5. æ£€æŸ¥æž„å»ºè„šæœ¬..."
        if [ -f toolchain/llvm_android/build.py ]; then
          echo "âœ… æž„å»ºè„šæœ¬å­˜åœ¨"
          python3 toolchain/llvm_android/build.py --help | head -10
        else
          echo "âŒ æž„å»ºè„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
    
    - name: "ðŸ—ï¸ æ‰§è¡Œç¬¬ä¸€é˜¶æ®µæž„å»ºï¼ˆBootstrapï¼‰"
      if: github.event.inputs.skip_stage1 != 'true'
      timeout-minutes: 120
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        echo "=== å¼€å§‹ç¬¬ä¸€é˜¶æ®µæž„å»º ==="
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "æž„å»ºå‘½ä»¤:"
        echo "python3 toolchain/llvm_android/build.py \\"
        echo "  --no-build windows \\"
        echo "  --skip-tests \\"
        echo "  --build-stage1-only \\"
        echo "  --no-musl"
        
        # åˆ›å»ºæž„å»ºæ—¥å¿—ç›®å½•
        mkdir -p ${{ env.BUILD_OUTPUT_DIR }}/logs
        
        # æ‰§è¡Œç¬¬ä¸€é˜¶æ®µæž„å»ºï¼Œæ•èŽ·è¯¦ç»†è¾“å‡º
        python3 toolchain/llvm_android/build.py \
          --no-build windows \
          --skip-tests \
          --build-stage1-only \
          --no-musl \
          2>&1 | tee ${{ env.BUILD_OUTPUT_DIR }}/logs/stage1_build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "ç¬¬ä¸€é˜¶æ®µæž„å»ºé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… ç¬¬ä¸€é˜¶æ®µæž„å»ºæˆåŠŸå®Œæˆ"
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          find out -name "clang" -type f -executable | head -5 | xargs file || true
        else
          echo "âŒ ç¬¬ä¸€é˜¶æ®µæž„å»ºå¤±è´¥"
          echo "æœ€åŽ50è¡Œæ—¥å¿—:"
          tail -50 ${{ env.BUILD_OUTPUT_DIR }}/logs/stage1_build.log
          exit $BUILD_EXIT_CODE
        fi
        
        echo "ç¬¬ä¸€é˜¶æ®µæž„å»ºç»“æŸæ—¶é—´: $(date)"
    
    - name: "ðŸ—ï¸ æ‰§è¡Œç¬¬äºŒé˜¶æ®µæž„å»ºï¼ˆå®Œæ•´å·¥å…·é“¾ï¼‰"
      timeout-minutes: 180
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        echo "=== å¼€å§‹ç¬¬äºŒé˜¶æ®µæž„å»º ==="
        echo "å¼€å§‹æ—¶é—´: $(date)"
        echo "æž„å»ºå‘½ä»¤:"
        echo "python3 toolchain/llvm_android/build.py \\"
        echo "  --no-build windows \\"
        echo "  --skip-tests \\"
        echo "  --single-stage \\"
        echo "  --no-musl"
        
        # æ‰§è¡Œç¬¬äºŒé˜¶æ®µæž„å»º
        python3 toolchain/llvm_android/build.py \
          --no-build windows \
          --skip-tests \
          --single-stage \
          --no-musl \
          2>&1 | tee ${{ env.BUILD_OUTPUT_DIR }}/logs/stage2_build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        echo "ç¬¬äºŒé˜¶æ®µæž„å»ºé€€å‡ºä»£ç : $BUILD_EXIT_CODE"
        
        # éªŒè¯æž„å»ºäº§ç‰©
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… ç¬¬äºŒé˜¶æ®µæž„å»ºæˆåŠŸå®Œæˆ"
          
          echo "æ£€æŸ¥æ ¸å¿ƒæž„å»ºäº§ç‰©..."
          if [ -f out/stage2/bin/clang ]; then
            echo "âœ… æ‰¾åˆ°clangç¼–è¯‘å™¨"
            out/stage2/bin/clang --version | head -5
          else
            echo "âŒ æœªæ‰¾åˆ°clangç¼–è¯‘å™¨"
            find out -name "clang" -type f | head -10
            exit 1
          fi
          
          if [ -f out/stage2/bin/lld ]; then
            echo "âœ… æ‰¾åˆ°lldé“¾æŽ¥å™¨"
            out/stage2/bin/lld --version | head -3
          fi
          
          if [ -d out/stage2/lib/clang ]; then
            echo "âœ… æ‰¾åˆ°Clangåº“æ–‡ä»¶"
            ls out/stage2/lib/clang/*/include/ | head -5
          fi
          
          # æ£€æŸ¥ç›®æ ‡æž¶æž„æ”¯æŒ
          echo "æ£€æŸ¥ç›®æ ‡æž¶æž„æ”¯æŒ..."
          out/stage2/bin/clang -print-targets | grep -i "${{ env.TARGET_HOST }}" || true
          
        else
          echo "âŒ ç¬¬äºŒé˜¶æ®µæž„å»ºå¤±è´¥"
          echo "æœ€åŽ100è¡Œæ—¥å¿—:"
          tail -100 ${{ env.BUILD_OUTPUT_DIR }}/logs/stage2_build.log
          exit $BUILD_EXIT_CODE
        fi
        
        echo "ç¬¬äºŒé˜¶æ®µæž„å»ºç»“æŸæ—¶é—´: $(date)"
        
        # ç”Ÿæˆæž„å»ºæ‘˜è¦
        echo "=== æž„å»ºäº§ç‰©ç»Ÿè®¡ ===" > ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "æž„å»ºæ—¶é—´: $(date)" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "--- äºŒè¿›åˆ¶æ–‡ä»¶ ---" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        find out/stage2/bin -type f -executable | wc -l >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "--- åº“æ–‡ä»¶ ---" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        find out/stage2/lib -type f | wc -l >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        echo "--- æ€»å¤§å° ---" >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        du -sh out/stage2 >> ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
    
    - name: "ðŸ“Š ç”Ÿæˆæž„å»ºæŠ¥å‘Š"
      run: |
        echo "=== æž„å»ºå®ŒæˆæŠ¥å‘Š ==="
        echo "æ€»æž„å»ºæ—¶é—´: çº¦$(( ($(date +%s) - $(cat ${{ env.BUILD_OUTPUT_DIR }}/logs/start_time.txt 2>/dev/null || echo $(date +%s)) ) / 60 )) åˆ†é’Ÿ"
        echo ""
        echo "æž„å»ºäº§ç‰©ä½ç½®: ${{ env.LLVM_SOURCE_ROOT }}/out/stage2"
        echo "æ—¥å¿—ç›®å½•: ${{ env.BUILD_OUTPUT_DIR }}/logs"
        
        # æ˜¾ç¤ºæž„å»ºæ‘˜è¦
        if [ -f ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt ]; then
          echo ""
          echo "æž„å»ºæ‘˜è¦:"
          cat ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        fi

  # ========== é˜¶æ®µå››ï¼šæ‰“åŒ…å’Œå‘å¸ƒäº§ç‰© ==========
  package-and-release:
    name: "ðŸ“¦ æ‰“åŒ…å’Œå‘å¸ƒäº§ç‰©"
    runs-on: ubuntu-22.04
    needs: execute-build
    timeout-minutes: 30
    
    steps:
    - name: "ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©"
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: ${{ env.WORKSPACE }}
    
    - name: "ðŸ·ï¸ ç¡®å®šäº§ç‰©ç›®å½•ç»“æž„"
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        # æ£€æŸ¥å®žé™…çš„æž„å»ºè¾“å‡ºç›®å½•ç»“æž„
        echo "=== åˆ†æžæž„å»ºè¾“å‡ºç›®å½•ç»“æž„ ==="
        find out -type d -name "*aarch64*" -o -name "*arm64*" | head -10
        
        # åŸºäºŽå¸¸è§æ¨¡å¼ç¡®å®šç›®æ ‡ç›®å½•å
        if [ -d out/stage2 ]; then
          if find out/stage2 -name "*aarch64*" | grep -q .; then
            PREBUILT_DIR="linux-aarch64"
          elif find out/stage2 -name "*arm64*" | grep -q .; then
            PREBUILT_DIR="linux-arm64"
          else
            # æ£€æŸ¥configs.pyä¸­çš„è®¾ç½®
            CONFIG_DIR=$(grep -r "prebuilt.*dir\|host_tag" toolchain/llvm_android/configs.py 2>/dev/null | grep -o "linux-[a-z0-9_-]*" | head -1 || echo "linux-aarch64")
            PREBUILT_DIR=$CONFIG_DIR
          fi
        else
          PREBUILT_DIR="linux-aarch64"
        fi
        
        echo "ç¡®å®šçš„ç›®æ ‡ç›®å½•: $PREBUILT_DIR"
        echo "PREBUILT_DIR=$PREBUILT_DIR" >> $GITHUB_ENV
        
        # åˆ›å»ºå®Œæ•´çš„NDKç›®å½•ç»“æž„
        NDK_VERSION="r25c-custom-$(date +%Y%m%d)"
        NDK_NAME="android-ndk-$NDK_VERSION"
        echo "NDK_NAME=$NDK_NAME" >> $GITHUB_ENV
        
        mkdir -p ${{ env.ARTIFACT_STAGING }}/$NDK_NAME/toolchains/llvm/prebuilt/$PREBUILT_DIR
    
    - name: "ðŸ“ å¤åˆ¶æž„å»ºäº§ç‰©åˆ°NDKç»“æž„"
      run: |
        cd ${{ env.LLVM_SOURCE_ROOT }}
        
        echo "å¤åˆ¶æž„å»ºäº§ç‰©..."
        if [ -d out/stage2 ]; then
          cp -r out/stage2/* ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }}/toolchains/llvm/prebuilt/${{ env.PREBUILT_DIR }}/
          echo "âœ… æž„å»ºäº§ç‰©å¤åˆ¶å®Œæˆ"
          
          # éªŒè¯å¤åˆ¶ç»“æžœ
          echo "äº§ç‰©ç»Ÿè®¡:"
          find ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }} -type f | wc -l
          du -sh ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }}
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°out/stage2ç›®å½•"
          find out -type d | head -20
          exit 1
        fi
    
    - name: "ðŸ“„ åˆ›å»ºNDKé…ç½®æ–‡ä»¶"
      run: |
        cd ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }}
        
        # åˆ›å»ºRELEASE.TXT
        cat > RELEASE.TXT << EOF
åŸºäºŽAndroid NDK r25cæž„å»ºçš„è‡ªå®šä¹‰å·¥å…·é“¾
æž„å»ºç›®æ ‡: ${{ env.TARGET_HOST }}
æž„å»ºæ—¶é—´: $(date -u)
æž„å»ºæ¥æº: ${{ github.repository }}
æäº¤å“ˆå¸Œ: ${{ github.sha }}
é¢„æž„å»ºç›®å½•: ${{ env.PREBUILT_DIR }}
æž„å»ºå‚æ•°: --single-stage --no-musl --skip-tests
EOF
        
        # åˆ›å»ºç®€å•çš„README
        cat > README.md << EOF
# è‡ªå®šä¹‰AArch64 Linuxä¸»æœºNDKå·¥å…·é“¾

## æ¦‚è¿°
æ­¤å·¥å…·é“¾åŸºäºŽAndroid NDK r25cçš„LLVMä»£ç æž„å»ºï¼Œä¸“é—¨é’ˆå¯¹**${{ env.TARGET_HOST }}**ä¸»æœºç³»ç»Ÿã€‚

## ç›®å½•ç»“æž„
\`\`\`
android-ndk-${{ env.NDK_VERSION }}/
â”œâ”€â”€ toolchains/
â”‚   â””â”€â”€ llvm/
â”‚       â””â”€â”€ prebuilt/
â”‚           â””â”€â”€ ${{ env.PREBUILT_DIR }}/  # å·¥å…·é“¾æ–‡ä»¶
â”œâ”€â”€ RELEASE.TXT
â””â”€â”€ README.md
\`\`\`

## ä½¿ç”¨æ–¹æ³•
\`\`\`bash
# è®¾ç½®çŽ¯å¢ƒå˜é‡
export NDK=\$(pwd)/android-ndk-${{ env.NDK_VERSION }}
export PATH=\$NDK/toolchains/llvm/prebuilt/${{ env.PREBUILT_DIR }}/bin:\$PATH

# ç¼–è¯‘Androidç¨‹åº
aarch64-linux-android33-clang your_source.c -o your_program
\`\`\`

## éªŒè¯
\`\`\`bash
# æ£€æŸ¥ç¼–è¯‘å™¨ç‰ˆæœ¬
aarch64-linux-android33-clang --version

# ç¼–è¯‘æµ‹è¯•ç¨‹åº
echo 'int main() { return 0; }' > test.c
aarch64-linux-android33-clang test.c -o test
file test
\`\`\`

## æ³¨æ„äº‹é¡¹
1. æ­¤å·¥å…·é“¾éœ€è¦åœ¨**aarch64æž¶æž„çš„Linuxç³»ç»Ÿ**ä¸Šè¿è¡Œ
2. ç›®æ ‡ç³»ç»Ÿéœ€è¦å®‰è£…å¿…è¦çš„è¿è¡Œåº“
3. è¿™æ˜¯è‡ªå®šä¹‰æž„å»ºç‰ˆæœ¬ï¼Œéžå®˜æ–¹å‘å¸ƒ
EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
    
    - name: "ðŸ“¦ åŽ‹ç¼©æ‰“åŒ…äº§ç‰©"
      run: |
        cd ${{ env.ARTIFACT_STAGING }}
        
        echo "å¼€å§‹åŽ‹ç¼©æ‰“åŒ…..."
        tar -czf ${{ env.NDK_NAME }}.tar.gz ${{ env.NDK_NAME }}
        
        echo "æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯:"
        ls -lh ${{ env.NDK_NAME }}.tar.gz
        
        # åˆ›å»ºSHA256æ ¡éªŒå’Œ
        sha256sum ${{ env.NDK_NAME }}.tar.gz > ${{ env.NDK_NAME }}.tar.gz.sha256
        
        echo "âœ… æ‰“åŒ…å®Œæˆ"
    
    - name: "ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: ndk-aarch64-linux-host
        path: |
          ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }}.tar.gz
          ${{ env.ARTIFACT_STAGING }}/${{ env.NDK_NAME }}.tar.gz.sha256
        retention-days: 14
    
    - name: "ðŸ“‹ ä¸Šä¼ æž„å»ºæ—¥å¿—"
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_OUTPUT_DIR }}/logs/
          ${{ env.BUILD_OUTPUT_DIR }}/build_summary.txt
        retention-days: 14
    
    - name: "ðŸ“Š ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š"
      run: |
        echo "=== æž„å»ºæµç¨‹å®ŒæˆæŠ¥å‘Š ===" > ${{ env.WORKSPACE }}/final_report.md
        echo "" >> ${{ env.WORKSPACE }}/final_report.md
        echo "## æž„å»ºè¯¦æƒ…" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **ä»“åº“**: ${{ github.repository }}" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **æäº¤**: ${{ github.sha }}" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **ç›®æ ‡ä¸»æœº**: ${{ env.TARGET_HOST }}" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **NDKç‰ˆæœ¬**: ${{ env.NDK_NAME }}" >> ${{ env.WORKSPACE }}/final_report.md
        echo "- **é¢„æž„å»ºç›®å½•**: ${{ env.PREBUILT_DIR }}" >> ${{ env.WORKSPACE }}/final_report.md
        echo "" >> ${{ env.WORKSPACE }}/final_report.md
        echo "## äº§å‡ºç‰©" >> ${{ env.WORKSPACE }}/final_report.md
        echo "1. **ndk-aarch64-linux-host**: åŒ…å«å®Œæ•´çš„NDKå·¥å…·é“¾" >> ${{ env.WORKSPACE }}/final_report.md
        echo "2. **build-logs**: åŒ…å«æ‰€æœ‰æž„å»ºæ—¥å¿—å’Œæ‘˜è¦" >> ${{ env.WORKSPACE }}/final_report.md
        echo "" >> ${{ env.WORKSPACE }}/final_report.md
        echo "## ä½¿ç”¨è¯´æ˜Ž" >> ${{ env.WORKSPACE }}/final_report.md
        echo "ä¸‹è½½ \`ndk-aarch64-linux-host\` äº§ç‰©åŽï¼Œè§£åŽ‹å¹¶è®¾ç½®çŽ¯å¢ƒå˜é‡å³å¯ä½¿ç”¨ã€‚" >> ${{ env.WORKSPACE }}/final_report.md
        echo "" >> ${{ env.WORKSPACE }}/final_report.md
        echo "```bash" >> ${{ env.WORKSPACE }}/final_report.md
        echo "tar -xzf android-ndk-${{ env.NDK_VERSION }}.tar.gz" >> ${{ env.WORKSPACE }}/final_report.md
        echo "export NDK=\$(pwd)/android-ndk-${{ env.NDK_VERSION }}" >> ${{ env.WORKSPACE }}/final-report.md
        echo "export PATH=\$NDK/toolchains/llvm/prebuilt/${{ env.PREBUILT_DIR }}/bin:\$PATH" >> ${{ env.WORKSPACE }}/final_report.md
        echo "```" >> ${{ env.WORKSPACE }}/final_report.md
        
        cat ${{ env.WORKSPACE }}/final_report.md
